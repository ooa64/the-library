<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>library admin</title>
  </head>

  <body onload=onLoad()>
    <p id="login"></p>
    <button onclick=logout()>logout</button>
    <hr/>

    <p>READERS:</p>
    <table id="readers">
      <tr>
          <th>name</th>
          <th>state</th>
          <th>action</th>
      </tr>
    </table>

    <p>LIBRARIANS:</p>
    <table id="librarians">
      <tr>
          <th>name</th>
          <th>action</th>
      </tr>
      <tr>
          <th><input id='librarian'/></th>
          <th><button onclick='addLibrarian(document.getElementById("librarian").value)'>add</button></th>
      </tr>

    </table>
    <p>BOOKS:</p>
    <table id="books">
      <tr>
        <th>id</th>
        <th>title</th>
        <th>author</th>
        <th>publisher</th>
        <th>published</th>
        <th>action</th>
      </tr>
      </tr>
      <tr>
        <td><input id="book.id"/></td>
        <td><input id="book.title"/></td>
        <td><input id="book.author"/></td>
        <td><input id="book.publisher"/></td>
        <td><input id="book.published"/></td>
        <td>
          <button onclick="saveBook()">save</button>
        </td>
      </tr>
    </table>

    <script>
      function onLoad() {
        getUser()
        getReaders()
        getLibrarians()
        getBooks()
      }
      function getUser() {
        fetch("/getuser").then(resp => resp.json()).then(json => {
          document.getElementById("login").textContent = `${json.role}: ${json.name}`
        })
      }
      //
      function getReaders() {
        fetch("/getusers?role=reader").then(resp => resp.json()).then(json => {
          let t = document.getElementById('readers').tBodies[0];
          while(t.childNodes.length > 2) {
            t.removeChild(t.lastChild)
          }
          for (const user of json) {
            t.appendChild(document.createElement('tr')).innerHTML = `
              <td>${user.name}</td>
              <td>${user.state}</td>
              <td>
                <button onclick=setReader('${user.name}','${user.state==="active"?"blocked":"active"}')>
                  (un)block
                </button>
              </td>`
          }
        })
      }
      function setReader(name, state) {
        let p = new URLSearchParams({name: name, state: state})
        fetch("/setreader?"+p).then(() => {
          getReaders()
        })
      }
      //
      function getLibrarians() {
        fetch("/getusers?role=librarian").then(resp => resp.json()).then(json => {
          let t = document.getElementById('librarians').tBodies[0]
          while(t.childNodes.length > 3) {
            t.removeChild(t.lastChild)
          }
          for (const user of json) {
            t.appendChild(document.createElement('tr')).innerHTML = `
              <td>${user.name}</td>
              <td>
                <button onclick=delLibrarian('${user.name}')>
                  delete
                </button>
              </td>`
          }
        })
      }
      function addLibrarian(name) {
        let p = new URLSearchParams({name: name})
        fetch("/addlibrarian?"+p).then(() => {
          getLibrarians()
        })
      }
      function delLibrarian(name) {
        let p = new URLSearchParams({name: name})
        fetch("/dellibrarian?"+p).then(() => {
          getLibrarians()
        })
      }
      //
      function getBooks() {
        fetch("/getbooks").then(resp => resp.json()).then(json => {
          let t = document.getElementById('books').tBodies[0]
          while(t.childNodes.length > 3) {
            t.removeChild(t.lastChild)
          }
          for (const book of json) {
            t.appendChild(document.createElement('tr')).innerHTML = `
              <td>${book.id}</td>
              <td>${book.title}</td>
              <td>${book.author}</td>
              <td>${book.publisher}</td>
              <td>${book.published}</td>
              <td>
                <button onclick='editBook(${JSON.stringify(book)})'>
                  edit
                </button>
                <button onclick='deleteBook(${book.id})'>
                  delete
                </button>
              </td>`
          }
        })
      }
      function editBook(book) {
        for (const f of ["id","title","author","publisher","published"]) {
          document.getElementById("book."+f).value = book[f]
        }
      }
      function saveBook() {
        let p = new URLSearchParams()
        for (const f of ["id","title","author","publisher","published"]) {
          p.append(f, document.getElementById("book."+f).value)
        }
        fetch("/setbook?"+p).then(resp => {
          if (resp.ok) {
            this.getBooks()
          } else {
            resp.text().then(text => alert(resp.statusText+"\n"+text))
          }
        });
      }
      function deleteBook(bookid) {
        let p = new URLSearchParams({id: bookid})
        fetch("/delbook?"+p).then(resp => {
          if (resp.ok) {
            this.getBooks()
          } else {
            resp.text().then(text => alert(resp.statusText+"\n"+text))
          }
        });
      }
      //
      function logout() {
        document.cookie = "libraryuser=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT" 
        window.location.href = "/";
      }
    </script>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 10px;
      }
    </style>
  </body>
</html>
